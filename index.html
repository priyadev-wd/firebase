<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stasht</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        .top_section {
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
            text-align: center;
            display: flex;
            width: 100%;
            height: 300px;
            justify-content: center;
            align-items: center;
        }

        .profile_card img {
            width: 70px;
        }

        .info_card img {
            width: 40px;
        }

        .info_card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
        }

        .comment-box img {
            width: 14px;
        }

        .bg_shadow {
            box-shadow: 0 0 18px rgba(0, 0, 0, .161) !important;
            position: relative;
            padding: 10px;
        }

        .main_img img {
            width: 100%;
            height: 280px;
            object-fit: cover;
            border-radius: 5px;
        }

        .profile_card h6 {
            color: white;
            font-size: 20px;
            font-weight: 700;
        }

        .info_card h6 {
            font-size: 14px;
            font-weight: 700;
            color: black;
            margin: 0;
        }

        .info_card p {
            color: #9087ff;
            font-size: 11px;
            font-weight: 400;
        }

        .comment-box a {
            text-decoration: none;
        }

        .download-icon-box {
            align-items: center;
            background: #ddd;
            border-radius: 8px;
            bottom: 66px;
            box-shadow: 0 3px 10px 2px rgba(0, 0, 0, .569);
            cursor: pointer;
            display: flex;
            height: 25px;
            justify-content: center;
            position: absolute;
            right: 20px;
            text-decoration: none;
            transition: all .5s ease;
            width: 25px;
        }

        .download-icon-box:hover {
            background: #d40303;
        }

        .download-icon-box:hover i {
            color: #fff;
        }x

        .download-icon-box i {
            color: #707070;
            font-size: 16px;
            transition: all .5s ease;
        }
    </style>
</head>

<body>

    <section> <!-- Add missing opening tag -->
        <div class="container">
            <h1> Welcome To Stash </h1>
            <div class="top_section">
					<div class="profile_card mx-auto">
						<img src="#" id="profileImage">
						<h6></h6>
					</div>
            </div>
        </div>
    </section>
    <section class="mt-5"> <!-- Correctly opened section -->
        <div class="container">
            <div class="row" id="photos">
            </div>
        </div>
    </section> <!-- Closing the correct section tag -->

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <!-- Firebase script (using ES Module) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script type="module">
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCoeZ_6KjJMBS3IJVijc_bYndBrvYJSaaM",
            authDomain: "stasht-staging.firebaseapp.com",
            projectId: "stasht-staging",
            storageBucket: "stasht-staging.appspot.com",
            messagingSenderId: "1049890183663",
            appId: "1:1049890183663:web:64439c59f42f8941a53e1a",
            measurementId: "G-JNDEPJQ09E"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Get memory ID from URL
        const params = new URLSearchParams(window.location.search);
        const memoryId = params.get('id');
        if (memoryId) {
            // Get the memory document by ID
            const memoryRef = db.collection('memories').doc(memoryId);

            memoryRef.get().then((doc) => {
                if (doc.exists) {
                const memoryData = doc.data();

                    // Extract image URLs from 'images_caption'
                const imagesCaption = memoryData.images_caption || [];

				const profileTitle = memoryData.title // Use caption.title for the title

                const profileCardTitleElement = document.querySelector('.profile_card h6');


					if (profileCardTitleElement) {
						profileCardTitleElement.textContent = profileTitle;
					} else {
						console.log('Profile card title element not found.');
					}
                    // Display photos on the HTML page
                    const photosContainer = document.getElementById('photos');

                    imagesCaption.forEach(caption => {
                        if (caption.image) {
                            // Decode the URL
                            const decodedUrl = decodeURI(caption.image);

                            // Extract the ID using URLSearchParams
                            const url = new URL(decodedUrl);
                            const id = url.searchParams.get('id');

            if (id) {
           // const userId = "yT5XZNxvwlciKtHe3Tpk";
           const userId = memoryData.created_by;

            const userDetail = db.collection('users').doc(userId);

            userDetail.get()
                .then((data) => {
                    console.log('Document fetched:', data);
                    if (data.exists) {
                        const userData = data.data();
                        const userName = userData.user_name;
                        console.log('User Data:', userData);

						// Selecting the image and name elements
						const profileImage = document.getElementById('profileImage');

						// Setting the image src and name dynamically
                        profileImage.src = userData.profile_image;

                        // Proceed with creating UI elements after getting user data
                        const createdAt = caption.created_at ? caption.created_at.toDate() : new Date();
                        const formattedDate = createdAt.toLocaleString(); // Customize the format if needed

						// Create a new column for each image
                        const colDiv = document.createElement('div');
                        colDiv.classList.add('col-md-3'); // Add Bootstrap column class

                        // Create the bg_shadow div
                        const bgShadowDiv = document.createElement('div');
                        bgShadowDiv.classList.add('bg_shadow');

                        // Create the info_card div
                        const infoCardDiv = document.createElement('div');
                        infoCardDiv.classList.add('info_card');

                        // Create the d-flex align-items-center div
                        const flexDiv = document.createElement('div');
                        flexDiv.classList.add('d-flex', 'align-items-center');

                        // Optional: Leave profile image blank
                        const profileImg = document.createElement('img');
                        profileImg.src = userData.profile_image;
                        flexDiv.appendChild(profileImg);

                        // Create text container inside the flexDiv
                        const textDiv = document.createElement('div');
                        textDiv.classList.add('py-1', 'px-2');

                        const cardTitle = document.createElement('h6');
                        cardTitle.classList.add('card-title', 'cat-title', 'mb-0');
                        cardTitle.textContent = userName; // Use userName after data is fetched

                        const cardText = document.createElement('p');
                        cardText.classList.add('cat-text', 'mb-0');
                        cardText.innerHTML = `<span>${formattedDate}</span>`; // Use the formatted date

                        textDiv.appendChild(cardTitle);
                        textDiv.appendChild(cardText);

                        // Append text content to the flexDiv
                        flexDiv.appendChild(textDiv);

                        // Create the comment box section
                        const commentBoxDiv = document.createElement('div');
                        commentBoxDiv.classList.add('comment-box');
                        const commentLink = document.createElement('a');
                        commentLink.href = "#"; // Example comment link
                        commentLink.innerHTML = `<h6 class="cursor-pointer">${caption.comment_count || 0} <img class="comment-icon" src="images/comment.svg"></h6>`;
                        commentBoxDiv.appendChild(commentLink);

                        // Append the flexDiv and commentBox to the info_card
                        infoCardDiv.appendChild(flexDiv);
                        infoCardDiv.appendChild(commentBoxDiv);

                        // Create the main image section for the dynamic memory photo
                        const mainImgDiv = document.createElement('div');
                        mainImgDiv.classList.add('main_img', 'my-2');
                        const memoryImg = document.createElement('img');
                        memoryImg.src = `https://drive.google.com/thumbnail?id=${id}&sz=w100`; // The dynamic image from Google Drive
                        memoryImg.alt = "Memory Photo";
                        mainImgDiv.appendChild(memoryImg);

                        // Create the description paragraph
                        const description = document.createElement('p');
                        description.textContent = caption.caption; // Use caption.caption for the description

                        // Create the download icon container
                        const downloadIconDiv = document.createElement('div');
                        downloadIconDiv.classList.add('download-icon-box');

                        // Create the download icon element (using Font Awesome)
                        const downloadIcon = document.createElement('i');
                        downloadIcon.classList.add('fa', 'fa-download');
                        downloadIcon.style.color = 'white';
                        downloadIcon.style.cursor = 'pointer';

                        // Set the click event to open the full-size image in a new tab
                        downloadIcon.onclick = () => {
                            const fullImageUrl = `https://drive.google.com/uc?id=${id}`; // Google Drive full-size image link
                            window.open(fullImageUrl, '_blank'); // Open in a new tab
                        };

                        // Append the download icon to the download icon container
                        downloadIconDiv.appendChild(downloadIcon);

                        // Append all created elements to the bg_shadow div
                        bgShadowDiv.appendChild(infoCardDiv);
                        bgShadowDiv.appendChild(mainImgDiv);
                        bgShadowDiv.appendChild(description);
                        bgShadowDiv.appendChild(downloadIconDiv);

                        // Append the column to the photos container
                        colDiv.appendChild(bgShadowDiv);
                        photosContainer.appendChild(colDiv);

                        // Update the background for the top section
                       const topSection = document.querySelector('.top_section');
						const backgroundImageUrl = `https://drive.google.com/thumbnail?id=${id}&sz=w300`;

						// Set the background image dynamically
						topSection.style.background = `url('${backgroundImageUrl}')`;
						topSection.style.backgroundSize = 'cover';
						topSection.style.backgroundPosition = 'center center';
						topSection.style.width = '100%';
						topSection.style.height = '300px';

						} else {
							console.log('No such document!');
						}
						})
						.catch((error) => {
							console.error('Error getting document:', error);
						});
				} else {
					console.log('ID not found in the URL');
				}
			}
		});
                } else {
                    console.log("No such document!");
                }
            }).catch((error) => {
                console.log("Error getting document:", error);
            });
        } else {


            console.log("No memory ID provided in URL.");
        }


    </script>

</body>

</html>
